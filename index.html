<html>
    <body>
        <hr>
        <p><i>I do not like work even when someone else does it.</i> -- MT</p>
        <hr>
        <hr>
        <div id="leftSandbox" style="float:left;border-size:1px;"></div>
        <div id="rightSandbox" style="float:right;border-size:1px;"></div>
        <div style="clear:both; bottom: 5px;">
            <hr>
            <hr>
            <br>
            <button onclick="resetStartTime()" id="start_time">Start Time: </button>
            <br>
            <hr>
            <p><button onclick="saveState()">Save?</button> (to browser)</p>
            <p><input type="checkbox" id="auto_save"></input> 5 minute auto-save?</p>
            <p><button onclick="loadSavedState()">Reload...</button> last saved state.</p>
            <button onclick="revealHiddenText()">Download what I wrote.</button>
        </div>
        <script>
            function getProjectName() {
                //<p>Project Name:  <input type:"text" id="project_name"></input> <button onclick="saveState()">Save!</button><button onclick="loadSavedState()">Load...</button></p>
                //not allowing users to pick names, to avoid clutter saved in the browser history.
                //if it were allowed:
                //return document.getElementById("project_name").value;
                return "tunnel_vision";
            }
            function getApi(name, keys) {
                var localStorage = window.localStorage;
                var keyDelim = "-";
                var jsonToReturn = {};
                if(name == null || name.length == 0) {
                    alert("Can't get unnamed project.");
                    return;
                }
                var keysLength = keys.length;
                for(var i=0; i < keysLength; i++) {
                    var key = keys[i];
                    jsonToReturn[key] = localStorage.getItem(name + keyDelim + key);
                }
                return jsonToReturn;
            }
            function saveApi(name, jsonToBeSaved) {
                var localStorage = window.localStorage;
                var keyDelim = "-";
                if(name == null || name.length == 0) {
                    alert("Can't save unless you name your project.");
                    return;
                }
                if(jsonToBeSaved == null || jsonToBeSaved.length == 0) {
                    alert("No data to save.");
                    return;
                }
                for (var key in jsonToBeSaved) {
                    localStorage.setItem(name + keyDelim + key, jsonToBeSaved[key]);
                }
            }
            function saveState(name) {
                if(name == null) {
                    name = getProjectName();
                }
                var texts = globalState.vars["hiddenText"] + document.getElementById("text_box").value;
                var notes = document.getElementById("notes").value;
                if(texts == null || texts.length == 0) {
                    alert("No data to save.");
                    return;
                }
                saveApi(name, {"text_box":texts, "notes":notes});
                globalState.vars["lastSaveTime"] = getTime();
            }
            function loadSavedState(name) {
                if(name == null) {
                    name = getProjectName();
                }
                if(name.length == 0) {
                    alert("Can't load unnamed project.");
                    return;
                }
                var state = getApi(name, ["text_box", "notes"]);
                globalState.vars["hiddenText"] = "";
                if(state["text_box"] != null) {
                    document.getElementById("text_box").value = state["text_box"];
                }
                if(state["notes"] != null) {
                    document.getElementById("notes").value = state["notes"];
                }
            }
            function getParameterByName(name, url) {
                if (!url) url = window.location.href;
                name = name.replace(/[\[\]]/g, "\\$&");
                var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, " "));
            }
            function processDivLoc(key, value) {
                var element = document.getElementById(key)
                if (element == null) {
                    element = document.createElement("DIV");
                    element.id = key;
                    if(key[0] == "R") {
                        document.getElementById("rightSandbox").appendChild(element);
                    } else  {
                        document.getElementById("leftSandbox").appendChild(element);
                    }
                }
                var widgetStateUpdate = {};
                if( value == null ) {
                    element.style.visibility = "hidden";
                    return;
                }
                element.style.visibility = "visible";
                switch(value) {
                    case "notes":
                        var notes = document.getElementById("notes");
                        if(notes == null) {
                            var notes = document.createElement("TEXTAREA");
                            notes.id = "notes";
                            notes.rows = "2";
                            notes.cols = "50";
                            notes.style.visibility = "visible";
                            var heading = document.createElement("p");
                            heading.innerHTML = "Notes:";
                            element.appendChild(heading);
                            element.appendChild(notes);
                        }
                        break;
                    case "tunnel":
                        var tunnel = document.getElementById("text_box");
                        if(tunnel == null) {
                            var maxText = document.createElement("input");
                            maxTextstype = "number";
                            maxText.id = "max_text";
                            maxText.min = "20";
                            maxText.max = "5000"
                            maxText.placeholder = "150";
                            maxText.defaultValue = "150";
                            var maxTextParent = document.createElement("p");
                            maxTextParent.innerHTML = "text display limit (20-5000 chars) ";
                            maxTextParent.appendChild(maxText);
                            btn = document.createElement("BUTTON");
                            var t = document.createTextNode("CLICK ME"); 
                            //btn.appendChild(t); 
                            //btn.onclick = toggleMaxTextActive;
                            //element.appendChild(btn);

                            var tunnel = document.createElement("TEXTAREA");
                            tunnel.id = "text_box";
                            tunnel.rows = "2";
                            tunnel.cols = "50";
                            tunnel.style.visibility = "visible";
                            element.appendChild(maxTextParent);
                            element.appendChild(document.createElement("br"));
                            element.appendChild(tunnel);
                        }
                        break;
                    case "stats":
                        var num_chars = document.getElementById("num_chars");
                        if(num_chars == null) {
                            var numChars = document.createElement("p");
                            numChars.id = "num_chars";
                            numChars.innerHTML = "Characters so far: 0";
                            var numWords = document.createElement("p");
                            numWords.id = "num_words";
                            numWords.innerHTML = "Word count: 0";
                            element.appendChild(numChars);
                            element.appendChild(numWords);
                            widgetStateUpdate[value] = function () {
                            }
                        }
                        break;
                    case "sprint":
                        var sprint = document.getElementById("sprint_time");
                        if(sprint == null){
                            var sprint = document.createElement("input");
                            sprint.type= "number";
                            sprint.id = "sprint_time";
                            sprint.min = "-1";
                            sprint.placeholder = "-1";
                            sprint.defaultValue = "-1";
                            var sprintParent = document.createElement("p");
                            sprintParent.innerHTML = "sprint length in minutes (-1 disables) ";
                            sprintParent.appendChild(sprint);

                            var countdown = document.createElement("p");
                            countdown.id = "countdown";
                            countdown.innerHTML = "-1 minutes to go";
                            element.appendChild(sprintParent);
                            element.appendChild(countdown);

                            widgetStateUpdate[value] = function() {
                                var sprintTime = document.getElementById("sprint_time");
                                if(sprintTime.value >= 0) {
                                    var countdown = document.getElementById("countdown");
                                    countdown.innerHTML = ((sprintTime.value * 60 + globalState.vars["startTime"] - getTime())/60).toFixed(0) + " minutes to go.";
                                    if(sprintTime.value * 60 + globalState.vars["startTime"] <= getTime()) {
                                        alert("Times up!");
                                        resetStartTime();
                                    }
                                }
                            }
                        }
                        break;
                    case "wpm":
                        var wpmButton = document.getElementById("wpm_button");
                        if(wpmButton == null){
                            var wpmButton = document.createElement("BUTTON");
                            wpmButton.id = "wpm_button";
                            wpmButton.onclick = toggleWordsPerMinute;
                            wpmButton.innerHTML = "Toggle Words/Minute";

                            var wpm = document.createElement("p");
                            wpm.id = "words_per_minute";
                            wpm.innerHTML = "Words/Minute: 0";
                            wpm.style.visibility = "visible";

                            element.appendChild(wpmButton);
                            element.appendChild(wpm);
                            widgetStateUpdate[value] = function() {
                                var wpm = document.getElementById("words_per_minute")
                                if(wpm != null) {
                                    wpm.innerHTML = "Words/Minute: " + computeWordsPerMinute().toFixed(2);
                                }
                            }
                        }
                        break;
                }
                return widgetStateUpdate;
            }
            function setupDivsFromURL() {
                var widgetState = {};
                //var divTypes = ["timer", "notes", "window", "sprint", "wpm", "stats"];
                //L1=tunnel&L2=stats&R1=notes&L3=wpm&R2=sprint
                var url = window.location.href;
                if(!document.location.search.length) {
                    //default to :
                    url += "?L1=tunnel&L2=stats&R1=notes&L3=wpm&R2=sprint";
                }
                var divLocs = ["L1", "L2", "L3", "L4", "L5", "L6", "R1", "R2", "R3", "R4", "R5", "R6"];
                for(var i = 0; i < divLocs.length; i++) {
                    var key = divLocs[i];
                    var value = getParameterByName(key, url);
                    var widgetStateUpdate = processDivLoc(key, value);
                    for(key in widgetStateUpdate) {
                        widgetState[key] = widgetStateUpdate[key];
                    }
                }
                return widgetState;
            }
            function getTime() {
                return new Date().getTime() / 1000;
            }
            function resetStartTime() {
                globalState.vars["startTime"] = getTime();
                globalState.vars["wordPerMinuteOffset"] = globalState.vars["wordCount"];
                document.getElementById("start_time").innerHTML = "Start Time: " + (new Date(globalState.vars["startTime"] * 1000)).toLocaleTimeString();
            }
            function computeWordsPerMinute() {
                return (globalState.vars["wordCount"]-globalState.vars["wordPerMinuteOffset"])*60.0/( getTime() - globalState.vars["startTime"]);
            }
            function toggleWordsPerMinute(){
                if (document.getElementById("words_per_minute").style.visibility != "visible") {
                   document.getElementById("words_per_minute").style.visibility = "visible" ;
                } else {
                   document.getElementById("words_per_minute").style.visibility = "hidden" ;
                }
            }
            function toggleMaxTextActive() {
                globalState.vars["maxTextActive"] = ! globalState.vars["maxTextActive"];
            }
            function collectInput(maxText) {
                var textBox = document.getElementById("text_box");
                var excessText = textBox.value.length; // Edge case that there are no spaces
                if(maxText == null) {
                    var maxTextInput = document.getElementById("max_text");
                    if(maxTextInput.value < maxTextInput.min || maxTextInput.value > maxTextInput.max) {
                        maxTextInput.value = maxTextInput.defaultValue;
                    }
                    maxText = maxTextInput.value;
                }

                if(maxText != 0) {
                    var excessTextSpace = textBox.value.lastIndexOf(" ", textBox.value.length - maxText);
                    var excessTextNewline = textBox.value.lastIndexOf("\n", textBox.value.length - maxText);
                    excessText = excessTextSpace;
                    if( excessText < excessTextNewline) {
                        excessText = excessTextNewline;
                    }
                }
                var keepText = textBox.value;
                var totalChars = globalState.vars["hiddenText"].length + textBox.value.length;
                if(excessText > 0) {
                    var newText = textBox.value.substring(0, excessText);
                    var newWords = newText.split(/[ \n]+/);
                    newWords = newWords.filter(function(entry) { return entry != ""; });
                    globalState.vars["hiddenWordCount"] += newWords.length 
                    globalState.vars["hiddenText"] += newText;
                    keepText = textBox.value.substring(excessText, textBox.value.length+10);
                    textBox.value = keepText;
                }
                globalState.vars["wordCount"] = globalState.vars["hiddenWordCount"] + keepText.split(/[ \n]+/).filter(function(entry) { return entry != ""; }).length;
                var numChars = document.getElementById("num_chars")
                if(numChars != null) {
                    numChars.innerHTML = "Characters so far: " + totalChars;
                    document.getElementById("num_words").innerHTML = "Word count: " + globalState.vars["wordCount"];
                }
                if (document.getElementById("auto_save").checked && (getTime() - globalState.vars["lastSaveTime"] > 5*60)) {
                    saveState();
                }
                for (key in widgetState) {
                    widgetState[key]();
                }
            }
            function revealHiddenText() {
                collectInput(0);
                document.write("<html><body><a href='data:text/plain;charset=utf-8," + escape(globalState.vars["hiddenText"]) +"' target=\"_blank\" download=\"tv.txt\">Download it!!</a><p style=\"white-space:pre-wrap;\">" + globalState.vars["hiddenText"] + "</p></body></html>");
                document.close();
            }

            var globalState = { 
                vars: {
                    hiddenText: "", 
                    hiddenWordCount: 0,
                    wordCount: 0,
                    wordPerMinuteOffset: 0,
                    maxTextActive: true,
                    startTime: -1,
                    lastSaveTime: -1
                }
            }

            var widgetState = setupDivsFromURL();
            resetStartTime();
            globalState.vars["lastSaveTime"] = globalState.vars["startTime"]; // TODO 2017-10-01 make this less hacky
            var pollFreq = 5000;
            var refreshIntervalId = setInterval("collectInput()", pollFreq);
            document.onkeypress = function(evt) {
                evt = evt || window.event;
                var charCode = evt.keyCode || evt.which;
                var charStr = String.fromCharCode(charCode);
                if(evt.ctrlKey && charStr == "s") {
                    saveState();
                }
            }
        </script>

    </body>
</html>
